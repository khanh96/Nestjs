### [Queues](https://docs.nestjs.com/techniques/queues)

- Lắng nghe và thực hiện queue sau khi add vào queue
```ts
@Processor(PAYMENT_QUEUE_NAME)
export class PaymentConsumer extends WorkerHost {
  constructor(private readonly sharedPaymentRepo: SharedPaymentRepository) {
    super()
  }
  async process(job: Job<{ paymentId: number }, any, string>): Promise<any> {
    switch (job.name) {
      case CANCEL_PAYMENT_JOB_NAME: {
        const { paymentId } = job.data
        await this.sharedPaymentRepo.cancelPaymentAndOrder(paymentId)
        console.log('Completed cancel payment job for paymentId:', paymentId)
        return {}
      }
      default:
        break
    }
    return {}
  }

  @OnWorkerEvent('active')
  onActive(job: Job) {
    console.log(`Processing job ${job.id} of type ${job.name}`)
  }

  @OnWorkerEvent('completed')
  onCompleted(job: Job, result: any) {
    console.log(`Job ${job.id} completed ${job.name}`, result)
  }

  @OnWorkerEvent('failed')
  onFailed(job: Job, error: Error) {
    console.log(`Job ${job.id} failed with error: ${error}`)
  }

  @OnWorkerEvent('stalled')
  onStalled(job: Job, error: Error) {
    console.log(`Job ${job.id} failed with error: ${error}`)
  }

  @OnWorkerEvent('error')
  onError(error: Error) {
    console.log(`Worker error: ${error}`)
  }

  @OnWorkerEvent('progress')
  onProgress(job: Job, progress: number) {
    console.log(`Job ${job.id} progress: ${progress}`)
  }
}

```


- Thực hiện add queue để thực thi một nv nào đó.
```ts
export class OrderProducer {
  constructor(@InjectQueue(PAYMENT_QUEUE_NAME) private paymentQueue: Queue) {
    // Log existing jobs in the payment queue upon initialization
    this.paymentQueue
      .getJobs()
      .then((jobs) => {
        console.log(
          `Current jobs in ${PAYMENT_QUEUE_NAME} queue:`,
          jobs.map((job) => job.data),
        )
      })
      .catch((err) => {
        console.error(`Failed to get jobs from ${PAYMENT_QUEUE_NAME} queue:`, err)
      })
  }
  async addCancelPaymentJob(paymentId: number) {
    console.log('Add cancel payment job to queue for paymentId:', paymentId)
    return this.paymentQueue.add(
      CANCEL_PAYMENT_JOB_NAME,
      {
        paymentId,
      },
      {
        delay: 1000 * 60 * 60 * 24, // delay 24 hours
        jobId: generateCancelPaymentJobId(paymentId),
        removeOnComplete: true,
        removeOnFail: true,
      },
    )
  }
}

```