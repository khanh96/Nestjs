### Technic


## Race condition

- Lỗi  Race condition (tình trạng tranh chấp) là lỗi xảy ra khi kết quả của chương trình phụ thuộc vào thứ tự hoặc thời điểm thực thi của các tiến trình/luồng, mà thứ tự này không được kiểm soát.
- Giải pháp: Pessimistic lock || Optimistic lock || RedLock

## Pessimistic lock
Pessimistic lock là cách tiếp cận "bi quan" - giả định xung đột sẽ xảy ra, nên khóa tài nguyên ngay trước khi truy cập và chỉ mở khóa sau khi hoàn thành.


Câu lệnh SQL lock 
```sql Ecommerce/ecom/src/routes/order/order.repo.ts
Khóa record với id là 1,2,3
SELECT * FROM "SKU" WHERE id IN 1,2,3 FOR UPDATE

Khóa record với id = 1
SELECT * FROM "SKU" WHERE id = 1 FOR UPDATE
```

## Optimistic lock
Optimistic lock (khóa lạc quan) là cách tiếp cận "lạc quan" - giả định xung đột hiếm khi xảy ra, nên không khóa tài nguyên khi đọc. Thay vào đó, `kiểm tra xem dữ liệu có bị thay đổi không trước khi cập nhật`.

- Cách hoạt động
Nguyên lý: Mỗi bản ghi có một version hoặc timestamp. Khi cập nhật, kiểm tra version có khớp không. Nếu không khớp = có người khác đã sửa = conflict.

- Lợi dụng query các giá trị không trùng khớp nên sẽ trả về lỗi VersionConflictException thì người dùng sẽ retry api đó.
```ts
for (const item of cartItems) {
    await tx.sKU
        .update({
        where: {
            id: item.sku.id,
            updatedAt: item.sku.updatedAt, // Sử dụng optimistic lock để tránh tình trạng oversell . Đảm bảo không có ai cập nhật SKU trong khi chúng ta đang xử lý
            stock: { gte: item.quantity }, // Đảm bảo số lượng tồn kho đủ để trừ
        },
        data: {
            stock: {
            decrement: item.quantity,
            },
        },
        })
        .catch((e) => {
        if (isNotFoundPrismaError(e)) {
            throw VersionConflictException
        }
        throw e
        })
    }
```