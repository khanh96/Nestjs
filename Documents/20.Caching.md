### [Caching](https://docs.nestjs.com/techniques/caching)

- Technique caching là là một kỹ thuật đơn giản dểd tối ưu performance. Bằng cách hoạt động như 1 lưu trữ tạm thời. Cho phép access nhanh với data thường xuyên truy cập.

- `In-memory cache` là cache ở chế độ app đang chạy. Khi tắt app thì sẽ không cache nữa.
- Để có thể cache ở cả khi mà app đã tắt thì sẽ cache ở redis

```ts Ecommerce/ecom/src/shared/guards/access-token.guard.ts
// 1. Thử lấy từ cache
let cachedRole = await this.cacheManager.get<CachedRole>(cacheKey)

// 2. Nếu không có trong cache, thì truy vấn từ cơ sở dữ liệu
if (!cachedRole) {
const role = await this.prismaService.role
  .findFirstOrThrow({
    where: {
      id: roleId,
      deletedAt: null,
      isActive: true,
    },
    include: {
      permissions: {
        where: {
          deletedAt: null,
        },
      },
    },
  })
  .catch(() => {
    throw new ForbiddenException()
  })

const permissionObject = keyBy(
  role.permissions,
  (permission) => `${permission.path}:${permission.method}`,
) as CachedRole['permissions']

cachedRole = { ...role, permissions: permissionObject }

console.log('cachedRole=>', cachedRole)

await this.cacheManager.set(cacheKey, cachedRole, 1000 * 60 * 60) // Cache for 1 hour
```


- Cache ở redis để khi tắt app vẫn lưu cache.
```ts
CacheModule.registerAsync({
      isGlobal: true,
      // configure the cache stores
      useFactory: () => {
        return {
          stores: [
            // new Keyv({
            //   store: new CacheableMemory({ ttl: 60000, lruSize: 5000 }),
            // })
            createKeyv({
              url: `redis://${envConfig.REDIS_HOST}:${envConfig.REDIS_PORT}`,
            }),
          ],
        }
      },
    }),
```